- name: Get RHEL lifecycle data from the Roadmap API
  hosts: localhost
  gather_facts: no
  become: no

  vars:
    RH_OFFLINE_TOKEN: "{{ lookup('env', 'RH_OFFLINE_TOKEN', default=Undefined) }}"
    SAVE_RESPONSE: "{{ lookup('env', 'SAVE_RESPONSE', default=False) }}"

  tasks:
    - name: Get access token
      uri:
        url: https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: refresh_token
          client_id: rhsm-api
          refresh_token: "{{ RH_OFFLINE_TOKEN }}"
      register: result

    - name: Get RHEL lifecycle data
      uri:
        url: https://console.redhat.com/api/roadmap/v1/lifecycle/rhel
        headers:
          Authorization: "Bearer {{ result.json.access_token }}"
      register: result

    - debug:
        msg: "{{ result.json.data | to_nice_json }}"

    - name: Save response
      copy:
        content: "{{ result.json.data | to_nice_json }}"
        dest: ../scratch/rhel-lifecycle.json
      when: SAVE_RESPONSE | bool
